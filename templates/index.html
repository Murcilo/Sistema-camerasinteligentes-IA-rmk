<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento Inteligente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>PAINEL DE MONITORAMENTO INTELIGENTE</h1>
            <p class="subtitle">Detec√ß√£o de Comportamentos An√¥malos em Tempo Real</p>
        </header>

        <!-- Controles -->
        <div class="controls">
            <button id="btnIniciar" class="btn btn-success" onclick="iniciarSistema()">
                ‚ñ∂Ô∏è Iniciar Sistema
            </button>
            <button id="btnParar" class="btn btn-danger" onclick="pararSistema()" disabled>
                ‚èπÔ∏è Parar Sistema
            </button>
        </div>

        <!-- Layout Principal -->
        <div class="main-layout">
            <!-- Coluna Esquerda: V√≠deo -->
            <div class="video-section">
                <h2>üìπ V√≠deo ao Vivo</h2>
                <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="V√≠deo ao Vivo">
            </div>

            <!-- Coluna Direita: Alertas e Status -->
            <div class="sidebar">
                <!-- Alertas -->
                <div class="alerts-section">
                    <h2>‚ö†Ô∏è Alertas</h2>
                    <div id="alertBox" class="alert-box">
                        üü¢ Nenhuma anomalia detectada
                    </div>
                </div>

                <div class="prompt-section">
                    <h2>üõ∞Ô∏è √öltima A√ß√£o Detectada</h2>
                    <div id="promptBox" class="prompt-box">
                        Aguardando atividade...
                    </div>
                </div>

                <!-- Status -->
                <div class="status-section">
                    <h2>üìä Status do Sistema</h2>
                    <div id="statusBox" class="status-box">
                        <div class="status-item">
                            <strong>Status:</strong> <span id="statusAtivo">üî¥ Inativo</span>
                        </div>
                        <div class="status-item">
                            <strong>Grava√ß√£o:</strong> <span id="statusGravando">‚ö™ Aguardando</span>
                        </div>
                        <div class="status-item">
                            <strong>IA:</strong> <span id="statusIA">‚úÖ Pronto</span>
                        </div>
                    </div>

                    <div class="chart-section">
                    <h2>üìà Atividade de Eventos</h2>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>

                    <button class="btn btn-primary" onclick="iniciarGravacao()">
                        üé• Iniciar Nova Grava√ß√£o
                    </button>
                </div>
            </div>
        </div>

        <!-- Galeria de V√≠deos -->
        <div class="gallery-section">
            <h2>üìÇ CLIPES DE ANOMALIAS GRAVADOS</h2>
            <div id="videoGallery" class="video-gallery">
                <p class="no-videos">Nenhum v√≠deo gravado ainda.</p>
            </div>
        </div>

        <!-- Footer -->
            </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='grafico.js') }}" defer></script>
    <script>
        // Atualiza status a cada segundo
        setInterval(atualizarStatus, 1000);

        // ATUALIZAR GALERIA E GR√ÅFICO (APENAS UM TIMER)
        setInterval(atualizarGaleriaEGrafico, 5000);
        // A linha 'setInterval(atualizarGaleria, 5000);' foi REMOVIDA

        // INICIALIZAR GR√ÅFICO QUANDO A P√ÅGINA CARREGAR
        document.addEventListener('DOMContentLoaded', (event) => {
            inicializarGrafico(); // Esta fun√ß√£o est√° agora em grafico.js
            atualizarGaleriaEGrafico(); // Carga inicial
        });

        function iniciarSistema() {
            fetch('/iniciar_sistema', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('btnIniciar').disabled = true;
                        document.getElementById('btnParar').disabled = false;
                        mostrarNotificacao(data.message, 'success');
                    } else {
                        mostrarNotificacao(data.message, 'error');
                    }
                })
                .catch(error => {
                    mostrarNotificacao('Erro ao iniciar sistema', 'error');
                });
        }

        function pararSistema() {
            fetch('/parar_sistema', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('btnIniciar').disabled = false;
                        document.getElementById('btnParar').disabled = true;
                        mostrarNotificacao(data.message, 'success');
                    } else {
                        mostrarNotificacao(data.message, 'error');
                    }
                })
                .catch(error => {
                    mostrarNotificacao('Erro ao parar sistema', 'error');
                });
        }

        function atualizarStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // --- Atualiza Status (sem altera√ß√£o) ---
                    document.getElementById('statusAtivo').innerHTML =
                        data.ativo ? 'üü¢ Ativo' : 'üî¥ Inativo';

                    document.getElementById('statusGravando').innerHTML =
                        data.gravando ? 'üî¥ Gravando' : '‚ö™ Aguardando';

                    document.getElementById('statusIA').innerHTML =
                        data.analisando ? 'üîÑ Analisando' : '‚úÖ Pronto';

                    
                    // --- L√≥gica de Alertas e Prompt (MODIFICADA) ---
                    const alertBox = document.getElementById('alertBox');
                    const promptBox = document.getElementById('promptBox');
                    
                    if (data.ultima_deteccao) {
                        // 1. L√ìGICA DO NOVO PAINEL (PROMPT)
                        // Sempre mostra a √∫ltima a√ß√£o detectada
                        promptBox.innerHTML = `
                            <strong>${data.ultima_deteccao.acao.toUpperCase()}</strong>
                            <br>
                            Confian√ßa: ${data.ultima_deteccao.confianca}
                            <br>
                            (${data.ultima_deteccao.timestamp})
                        `;
                        promptBox.className = 'prompt-box prompt-active';


                        // 2. L√ìGICA ANTIGA (ALERTAS)
                        // S√≥ ativa se for um 'evento' (anomalia)
                        if (data.ultima_deteccao.evento) {
                            const evento = data.ultima_deteccao.evento.replace(/_/g, ' ');
                            alertBox.innerHTML = `
                                <div class="alert-warning">
                                    <strong>‚ö†Ô∏è ALERTA: ${evento.toUpperCase()}!</strong><br>
                                    A√ß√£o: ${data.ultima_deteccao.acao}
                                </div>
                            `;
                            alertBox.className = 'alert-box alert-active';
                        } else {
                            // Se a √∫ltima a√ß√£o n√£o foi um evento, o alerta fica verde
                            alertBox.innerHTML = 'üü¢ Nenhuma anomalia detectada';
                            alertBox.className = 'alert-box';
                        }

                    } else {
                        // Estado inicial (sem detec√ß√µes)
                        alertBox.innerHTML = 'üü¢ Nenhuma anomalia detectada';
                        alertBox.className = 'alert-box';
                        promptBox.innerHTML = 'Aguardando atividade...';
                        promptBox.className = 'prompt-box';
                    }
                })
                .catch(error => console.error('Erro ao atualizar status:', error));
        }

        // ***** IN√çCIO DA CORRE√á√ÉO *****

        // 1. ESTA √â A FUN√á√ÉO QUE ESTAVA FALTANDO (ou estava com o nome errado)
        // Ela busca os dados UMA VEZ e distribui para as outras fun√ß√µes.
        function atualizarGaleriaEGrafico() {
            fetch('/videos')
                .then(response => response.json())
                .then(videos => {
                    // Envia os dados para as duas fun√ß√µes
                    atualizarGaleria(videos);
                    atualizarGrafico(videos); // Esta fun√ß√£o est√° em grafico.js
                })
                .catch(error => console.error('Erro ao atualizar dados:', error));
        }

        // 2. ESTA FUN√á√ÉO FOI MODIFICADA
        // Ela agora recebe 'videos' e n√£o busca mais dados por conta pr√≥pria.
        function atualizarGaleria(videos) { 
            // A linha 'fetch('/videos')' foi REMOVIDA daqui
            
            const gallery = document.getElementById('videoGallery');

            if (videos.length === 0) {
                gallery.innerHTML = '<p class="no-videos">Nenhum v√≠deo gravado ainda.</p>';
            } else {
                gallery.innerHTML = videos.map(video => `
                    <div class="video-card">
                        <video controls>
                            <source src="/${video.caminho}" type="video/mp4">
                        </video>
                        <p class="video-title">${video.evento}</p>
                        <p class="video-time">${video.timestamp}</p>
                    </div>
                `).join('');
            }
        }
        
        // ***** FIM DA CORRE√á√ÉO *****


        function iniciarGravacao() {
            fetch('/iniciar_gravacao', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    mostrarNotificacao(data.message, data.status === 'success' ? 'success' : 'error');
                })
                .catch(error => {
                    mostrarNotificacao('Erro ao iniciar grava√ß√£o', 'error');
                });
        }

        function mostrarNotificacao(mensagem, tipo) {
            // Cria notifica√ß√£o simples
            const notif = document.createElement('div');
            notif.className = `notification notification-${tipo}`;
            notif.textContent = mensagem;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>